#!/bin/bash

set -e

DEBROOT=$(pwd)

export ARCH=arm64
export CROSS_COMPILE=aarch64-linux-gnu-

# make sure that we have build directory
mkdir -p build
cd build

# let's have a clean tree
rm -rf esp8089
git clone https://github.com/al177/esp8089.git

# download linux
rm -rf linux
if [ "$(date +'%V%y')" != "$(cat kern-dl-date)" ]; then
	date +'%V%y' > kernl-dl-date
	mkdir -p linux
	rm linux.tar.xz || true
	curl -L https://$(curl -sL https://www.kernel.org | grep "Download complete tarball" | cut -d '.' -f 2- | cut -d '"' -f 1 | grep pub | head -n1) -o linux.tar.xz
fi

tar -xJf linux.tar.xz --strip-components=1 -C linux


cd linux

# adc-joystick dt binding, https://lkml.org/lkml/2020/7/3/886
wget https://lore.kernel.org/patchwork/patch/1267742/raw/ -O arm64-dts-rockchip-add-adc-joystick-to-Odroid-Go-Advance.diff
patch -p1 < arm64-dts-rockchip-add-adc-joystick-to-Odroid-Go-Advance.diff

# moar patches
patch -p1 < $DEBROOT/res/px30-spidev.patch
patch -p1 < $DEBROOT/res/odroid-go2-psci-poweroff.patch

# build

cp $DEBROOT/res/linux-config ./.config
make olddefconfig
make -j$(nproc)

export KBUILD=$DEBROOT/build/linux/
export KERNELRELEASE=$(make kernelversion)
export SRC_DIR=$DEBROOT/build/esp8089/

cd $DEBROOT/build/esp8089
#make -j$(nproc) # yes i am doing everything to not fix esp8089


